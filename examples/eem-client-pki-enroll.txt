! File Chain (see DEVELOPER.md):
! Doc Version: v1.0.1
! Date Modified: 2026-02-16
!
! - Called by: Operators pasting config onto client routers
! - Reads from: Event manager environment (CA_AUTH_DONE, ENROLL_DONE), CLI (show crypto pki certificates lab-ca-tp)
! - Writes to: Event manager environment CA_AUTH_DONE 1, ENROLL_DONE 1 (no write memory; applet is watchdog)
! - Calls into: None (IOS EEM interpreter)
!
! doc_rev: 1 | date: 2026-02-14 | status: unverified — commit when verified working on device
!
! =============================================================================
! EEM Client PKI Enrollment — Authenticate (TOFU) + Enroll
! =============================================================================
! Use with TopoGen --pki: client router config already has trustpoint lab-ca-tp
! (enrollment url http://10.10.255.254, subject-name cn=<FQDN>, rsakeypair).
! FQDN is in the request via the trustpoint; script only needs to accept CA and
! enroll.
!
! EEM cannot send "yes" to interactive prompts. So: run the two commands once
! (manually or from console script), then this applet sets latches when it sees
! the certs. Retries every 120s until both latches are set.
!
! Run once per router (answer yes to both):
!   crypto pki authenticate lab-ca-tp
!   crypto pki enroll lab-ca-tp
! =============================================================================

!no event manager applet CLIENT-PKI-ENROLL
event manager applet CLIENT-PKI-ENROLL authorization bypass
 event timer watchdog time 120
 action 0.1 cli command "enable"
 action 0.2 syslog msg "EEM CLIENT-PKI-ENROLL: executed [step 0.2]"
 action 0.3 cli command "terminal length 0"
 action 0.4 cli command "show event manager environment | include ENROLL_DONE"
 action 0.5 regexp "ENROLL_DONE 1" "$_cli_result" match
 action 0.6 if $_regexp_result eq "1"
  action 0.7 exit
  action 0.8 end
! Set CA_AUTH_DONE when CA cert is present (you already ran authenticate + yes)
 action 1.0 cli command "show event manager environment | include CA_AUTH_DONE"
 action 1.1 regexp "CA_AUTH_DONE 1" "$_cli_result" match
 action 1.2 if $_regexp_result ne "1"
  action 1.3  cli command "show crypto pki certificates lab-ca-tp"
  action 1.4  regexp "CA Certificate|Certificate Name:.*CA-ROOT" "$_cli_result" match
  action 1.5  if $_regexp_result eq "1"
   action 1.6   cli command "configure terminal"
   action 1.7   cli command "event manager environment CA_AUTH_DONE 1"
   action 1.8   cli command "end"
   action 1.9   syslog msg "EEM CLIENT-PKI-ENROLL: CA_AUTH_DONE set [step 1.9]"
  action 1.10 end
  action 1.11 end
! Set ENROLL_DONE when identity cert is present (you already ran enroll + yes)
 action 2.0 cli command "show event manager environment | include ENROLL_DONE"
 action 2.1 regexp "ENROLL_DONE 1" "$_cli_result" match
 action 2.2 if $_regexp_result ne "1"
  action 2.3  cli command "show crypto pki certificates lab-ca-tp"
  action 2.4  regexp "Certificate Name:.*Available" "$_cli_result" match
  action 2.5  if $_regexp_result eq "1"
   action 2.6   cli command "configure terminal"
   action 2.7   cli command "event manager environment ENROLL_DONE 1"
   action 2.8   cli command "end"
   action 2.9   syslog msg "EEM CLIENT-PKI-ENROLL: ENROLL_DONE set [step 2.9]"
  action 2.10 end
  action 2.11 end
end
