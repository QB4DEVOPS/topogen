! File Chain (see DEVELOPER.md):
! Doc Version: v1.0.1
! Date Modified: 2026-02-16
!
! - Called by: Operators pasting config; render.py when injecting CA clock EEM (offline flat/DMVPN)
! - Reads from: Event manager environment (TIME_DONE), CLI (show ntp status)
! - Writes to: NVRAM (write memory), event manager environment TIME_DONE 1, removes this applet from running-config
! - Calls into: None (IOS EEM interpreter)
!
! doc_rev: 1 | date: 2026-02-14 | status: unverified â€” commit when verified working on device
!
! EEM applet CA-ROOT-SET-CLOCK: one-shot 90s after boot on CA-ROOT.
! If NTP already synchronized, sets TIME_DONE and exits (clock not changed).
! If not, forces clock set, ntp master 6, then sets TIME_DONE.
! Run-once: sets success var, deletes self, write mem.
! Use with TopoGen --pki: CA-ROOT router. Pair with clients that trigger on PKI-6-AUTHORITATIVE_CLOCK.
!
! Initial env (first boot): event manager environment TIME_DONE 0
! After first run: event manager environment TIME_DONE 1
!
!no event manager applet CA-ROOT-SET-CLOCK
event manager applet CA-ROOT-SET-CLOCK authorization bypass
 event timer countdown time 90
 action 0.1 cli command "enable"
 action 0.2 syslog msg "EEM CA-ROOT-SET-CLOCK: executed [step 0.2]"
 action 0.3 cli command "terminal length 0"
 action 0.4 cli command "show event manager environment | include TIME_DONE"
 action 0.5 regexp "TIME_DONE 1" "$_cli_result" match
 action 0.6 if $_regexp_result eq "1"
  action 0.7  exit
  action 0.8 end
 action 1.0 cli command "show ntp status"
 action 1.1 regexp "Clock is synchronized" "$_cli_result" match
 action 1.2 if $_regexp_result eq "1"
  action 1.3  cli command "configure terminal"
  action 1.4  cli command "event manager environment TIME_DONE 1"
  action 1.5  cli command "no event manager applet CA-ROOT-SET-CLOCK"
  action 1.6  cli command "end"
  action 1.7  cli command "write memory"
  action 1.8  syslog msg "EEM CA-ROOT-SET-CLOCK: TIME_DONE set (NTP synced) [step 1.8]"
  action 1.9  exit
  action 1.10 end
 action 2.0 cli command "configure terminal"
 action 2.1 cli command "do clock set 00:00:01 February 13 2026"
 action 2.2 cli command "end"
 action 3.0 cli command "configure terminal"
 action 3.1 cli command "ntp master 6"
 action 3.2 cli command "end"
 action 4.0 cli command "configure terminal"
 action 4.1 cli command "event manager environment TIME_DONE 1"
 action 4.2 cli command "no event manager applet CA-ROOT-SET-CLOCK"
 action 4.3 cli command "end"
 action 4.4 cli command "write memory"
 action 4.5 syslog msg "EEM CA-ROOT-SET-CLOCK: TIME_DONE set (clock + ntp master 6) [step 4.5]"
end
