hostname {{ node.hostname }}
!
service timestamps debug datetime msec
service timestamps log datetime msec
no service password-encryption
no service config
enable password {{ config.password }}
ip classless
ip subnet-zero
ip domain lookup
ip name-server {{ config.nameserver }}
ip domain name {{ config.domainname }}
crypto key generate rsa modulus 2048
ip ssh version 2
ip ssh server algorithm authentication password
username {{ config.username }} privilege 15 secret {{ config.password }}
cdp run
!
{%- set ns = namespace(seen={}) %}
{%- for iface in node.interfaces %}
{%- if iface.vrf and not ns.seen.get(iface.vrf) %}
vrf definition {{ iface.vrf }}
 rd 1:1
 address-family ipv4
 exit-address-family
!
{%- set _ = ns.seen.update({iface.vrf: true}) %}
{%- endif %}
{%- endfor %}
{%- if origin %}
ip route 0.0.0.0 0.0.0.0 {{ origin.ip }}
!
{%- endif %}
int Loopback0
    ip address {{ node.loopback.ip }} {{ node.loopback.netmask }}
!
{%- set ns_vrf = namespace(has=false) %}
{%- for iface in node.interfaces %}
{%- if iface.vrf %}
{%- set ns_vrf.has = true %}
{%- endif %}
{%- endfor %}
{%- if ns_vrf.has %}
router eigrp TOPGEN
 !
 {%- set ns_eigrp = namespace(seen={}) %}
 {%- for iface in node.interfaces if iface.address and iface.vrf %}
 {%- if not ns_eigrp.seen.get(iface.vrf) %}
 address-family ipv4 unicast vrf {{ iface.vrf }} autonomous-system 100
  !
  topology base
  exit-af-topology
  {%- set _ = ns_eigrp.seen.update({iface.vrf: true}) %}
  {%- for v in node.interfaces if v.address and v.vrf == iface.vrf %}
  network {{ v.address.ip }} 0.0.0.0
  {%- endfor %}
 exit-address-family
 !
 {%- endif %}
 {%- endfor %}
 address-family ipv4 unicast autonomous-system 100
  !
  topology base
  exit-af-topology
  {%- for iface in node.interfaces if iface.address and not iface.vrf %}
  network {{ iface.address.ip }} 0.0.0.0
  {%- endfor %}
  network {{ node.loopback.ip }} 0.0.0.0
 exit-address-family
!
{%- else %}
router eigrp 100
 network {{ node.loopback.ip }} 0.0.0.0
 {%- for iface in node.interfaces if iface.address %}
 network {{ iface.address.ip }} 0.0.0.0
 {%- endfor %}
 passive-interface Loopback0
!
{%- endif %}
{%- for iface in node.interfaces %}
interface GigabitEthernet{{ loop.index0 + 1 }}
    {%- if iface.description %}
    description {{ iface.description }}
    {%- endif %}
    {%- if iface.vrf %}
    vrf forwarding {{ iface.vrf }}
    {%- endif %}
    {%- if iface.address %}
    ip address {{ iface.address.ip }} {{ iface.address.netmask }}
    {%- endif %}
    cdp enable
    no shutdown
!
{%- endfor %}
line vty 0 4
    transport input ssh telnet
    exec-timeout 720 0
    login local
line con 0
    password {{ config.password }}
    exec-timeout 0 0
!
end
