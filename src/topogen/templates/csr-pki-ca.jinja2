{# PKI Root CA Template for IOS-XE (CSR1000v ONLY - currently)
#
# Purpose: Generates startup configuration for a PKI Root CA router (CA-ROOT)
#          with PKI server, HTTP/HTTPS, NTP master, and EIGRP routing.
#
# IMPORTANT: CA-ROOT is always deployed as CSR1000v (csr1000v node definition).
#            This template uses CSR-style interface names (GigabitEthernet1, not Gi0/1).
#            Future TODO: Support IOSv if PKI server works on IOSv platform.
#
# File Chain (see DEVELOPER.md):
# Doc Version: v1.2.0
# Date Modified: 2026-02-24
#
# - Called by: src/topogen/render.py (Jinja render step in offline_flat_yaml)
# - Reads from: Jinja context (config, node, plus feature flags: mgmt, ntp, pki_enabled)
# - Writes to: Startup-config text embedded into offline YAML, or pushed to the controller (online)
# - Calls into: None (template-only)
#
# Context Variables:
# - config: Config object (username, password, nameserver, domainname)
# - node: TopogenNode (hostname, loopback, interfaces)
# - mgmt: Management config (enabled, slot, vrf, gw) - optional
# - ntp: NTP config (server, vrf) - optional
# - origin: Default route origin IP - optional
#
# PKI-specific features:
# - Named RSA key generation (CA-ROOT.server) - required for PKI server
# - NTP master 5 (authoritative time source for PKI) - required before PKI init
# - HTTP/HTTPS server (required for SCEP enrollment URL)
# - PKI server CA-ROOT (grant auto, lifetimes, database on flash, database level complete)
#
# Routing: EIGRP 100 (classic mode) or EIGRP TOPGEN (VRF-aware named mode)
#
# Blast Radius (what breaks if you modify this):
# - CA-ROOT router configuration in all offline YAML labs with --pki flag
# - PKI server initialization and SCEP enrollment URL functionality
# - NTP master timing (affects PKI certificate validity checks)
# - Routing adjacencies between CA and regular routers (EIGRP)
#}
hostname {{ node.hostname }}
!
service timestamps debug datetime msec
service timestamps log datetime msec
no service password-encryption
no service config
enable password {{ config.password }}
ip classless
ip subnet-zero
ip domain lookup
ip name-server {{ config.nameserver }}
ip domain name {{ config.domainname }}
ip ssh version 2
ip ssh server algorithm authentication password
username {{ config.username }} privilege 15 secret {{ config.password }}
cdp run
!
crypto key generate rsa modulus 2048 label CA-ROOT.server exportable
!
{%- set ns = namespace(seen={}) %}
{%- for iface in node.interfaces %}
{%- if iface.vrf and not ns.seen.get(iface.vrf) %}
vrf definition {{ iface.vrf }}
 rd 1:1
 address-family ipv4
 exit-address-family
!
{%- set _ = ns.seen.update({iface.vrf: true}) %}
{%- endif %}
{%- endfor %}
{%- if origin %}
ip route 0.0.0.0 0.0.0.0 {{ origin.ip }}
!
{%- endif %}
int Loopback0
    ip address {{ node.loopback.ip }} {{ node.loopback.netmask }}
!
{%- set ns_vrf = namespace(has=false) %}
{%- for iface in node.interfaces %}
{%- if iface.vrf %}
{%- set ns_vrf.has = true %}
{%- endif %}
{%- endfor %}
{%- if ns_vrf.has %}
router eigrp TOPGEN
 !
 {%- set ns_eigrp = namespace(seen={}) %}
 {%- for iface in node.interfaces if iface.address and iface.vrf %}
 {%- if not ns_eigrp.seen.get(iface.vrf) %}
 address-family ipv4 unicast vrf {{ iface.vrf }} autonomous-system 100
  !
  topology base
  exit-af-topology
  {%- set _ = ns_eigrp.seen.update({iface.vrf: true}) %}
  {%- for v in node.interfaces if v.address and v.vrf == iface.vrf %}
  network {{ v.address.ip }} 0.0.0.0
  {%- endfor %}
 exit-address-family
 !
 {%- endif %}
 {%- endfor %}
 address-family ipv4 unicast autonomous-system 100
  !
  topology base
  exit-af-topology
  {%- for iface in node.interfaces if iface.address and not iface.vrf %}
  network {{ iface.address.ip }} 0.0.0.0
  {%- endfor %}
  network {{ node.loopback.ip }} 0.0.0.0
 exit-address-family
!
{%- else %}
router eigrp 100
 {%- if eigrp_stub|default(false) %}
 eigrp stub connected summary
 {%- endif %}
 network {{ node.loopback.ip }} 0.0.0.0
 {%- for iface in node.interfaces if iface.address %}
 network {{ iface.address.ip }} 0.0.0.0
 {%- endfor %}
 passive-interface Loopback0
!
{%- endif %}
{%- for iface in node.interfaces %}
interface GigabitEthernet{{ loop.index0 + 1 }}
    {%- if loop.first %}
    description === SCEP Enrollment URL ===
    {%- elif iface.description %}
    description {{ iface.description }}
    {%- endif %}
    {%- if iface.vrf %}
    vrf forwarding {{ iface.vrf }}
    {%- endif %}
    {%- if iface.address %}
    ip address {{ iface.address.ip }} {{ iface.address.netmask }}
    {%- endif %}
    cdp enable
    no shutdown
!
{%- endfor %}
{%- if mgmt and mgmt.enabled %}
{%- if mgmt.vrf %}
vrf definition {{ mgmt.vrf }}
 rd 1:{{ mgmt.slot }}
 address-family ipv4
 exit-address-family
!
{%- endif %}
interface GigabitEthernet{{ mgmt.slot }}
    description OOB Management
    {%- if mgmt.vrf %}
    vrf forwarding {{ mgmt.vrf }}
    {%- endif %}
    ip address dhcp
    no shutdown
!
{%- if mgmt.gw %}
{%- if mgmt.vrf %}
ip route vrf {{ mgmt.vrf }} 0.0.0.0 0.0.0.0 {{ mgmt.gw }}
{%- else %}
ip route 0.0.0.0 0.0.0.0 {{ mgmt.gw }}
{%- endif %}
{%- endif %}
{%- endif %}
{%- if ntp and ntp.server %}
{%- if ntp.vrf %}
ntp server vrf {{ ntp.vrf }} {{ ntp.server }}
{%- else %}
ntp server {{ ntp.server }}
{%- endif %}
!
{%- endif %}
{%- if ntp_oob and ntp_oob.server and ntp_oob.vrf %}
ntp server vrf {{ ntp_oob.vrf }} {{ ntp_oob.server }}
!
{%- endif %}
ntp master 6
!
ip http server
ip http secure-server
ip http secure-server trustpoint CA-ROOT-SELF
!
crypto pki server CA-ROOT
 database level complete
 no database archive
 grant auto
 lifetime certificate 7300
 lifetime ca-certificate 7300
 database url flash:
 no shutdown
!
{%- if archive %}
archive
 log config
  logging enable
  notify syslog contenttype plaintext
  hidekeys
 path flash:
 maximum 5
 write-memory
!
alias exec rundiff show archive config differences system:running-config
!
{%- endif %}
!
event manager applet TOPOGEN-NOSHUT authorization bypass
 event timer cron cron-entry "@reboot"
 action 1.0 cli command "enable"
 action 1.1 cli command "terminal length 0"
 action 1.2 cli command "show event manager environment | include NOSHUT_DONE"
 action 1.3 regexp "NOSHUT_DONE 1" "$_cli_result" match
 action 1.4 if $_regexp_result eq "1"
 action 1.5  syslog msg "TOPOGEN-NOSHUT: already applied, skipping"
 action 1.6  exit
 action 1.7 end
 action 2.0 cli command "config t"
{%- set ns_eem = namespace(n=3) %}
{%- for iface in node.interfaces %}
 action {{ ns_eem.n }}.0 cli command "interface GigabitEthernet{{ loop.index0 + 1 }}"
 action {{ ns_eem.n }}.1 cli command "no shutdown"
{%- set ns_eem.n = ns_eem.n + 1 %}
{%- endfor %}
{%- if mgmt and mgmt.enabled %}
 action {{ ns_eem.n }}.0 cli command "interface GigabitEthernet{{ mgmt.slot }}"
 action {{ ns_eem.n }}.1 cli command "no shutdown"
{%- set ns_eem.n = ns_eem.n + 1 %}
{%- endif %}
 action {{ ns_eem.n }}.0 cli command "event manager environment NOSHUT_DONE 1"
 action {{ ns_eem.n }}.1 cli command "end"
{%- set ns_eem.n = ns_eem.n + 1 %}
 action {{ ns_eem.n }}.0 cli command "write memory"
 action {{ ns_eem.n }}.1 syslog msg "TOPOGEN-NOSHUT: interfaces initialized, config saved"
!
line vty 0 4
    transport input ssh telnet
    exec-timeout 0 0
    login local
line con 0
    password {{ config.password }}
    exec-timeout 0 0
!
end
